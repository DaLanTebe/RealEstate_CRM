# Rate limiting zones
limit_req_zone $binary_remote_addr zone=api_core:10m rate=100r/s;
limit_req_zone $binary_remote_addr zone=api_processor:10m rate=200r/s;
limit_req_zone $binary_remote_addr zone=api_price:10m rate=50r/s;
limit_req_zone $binary_remote_addr zone=api_notifications:10m rate=300r/s;

upstream core_crm {
    server core-crm:8080;
}

upstream content_loader {
    server content-loader-adapter:8081;
}

upstream content_processor {
    server content-processor:8082;
}

upstream price_history {
    server price-history:8084;
}

upstream notifications {
    server notification-service:8085;
}

server {
    listen 80;
    server_name localhost;
    client_max_body_size 10M;

    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Core CRM
    location /api/core/ {
        # Rate Limiting
        limit_req zone=api_core burst=50 nodelay;
        limit_req_status 429;

        # Circuit Breaker
        proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
        proxy_next_upstream_timeout 3s;
        proxy_next_upstream_tries 2;

        # Таймауты
        proxy_connect_timeout 5s;
        proxy_send_timeout 15s;
        proxy_read_timeout 15s;

        # Буферизация
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;

        # Заголовки
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # Security headers
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;

        proxy_pass http://core_crm/;
    }

    # Content Loader
    location /api/content/loader/ {
        # Большой размер файлов
        client_max_body_size 100M;

        # Длинные таймауты для загрузки
        proxy_connect_timeout 30s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # Ретраи для неудачных загрузок
        proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
        proxy_next_upstream_timeout 10s;
        proxy_next_upstream_tries 3;

        # Отключение буферизации для больших файлов
        proxy_buffering off;
        proxy_request_buffering off;

        # Заголовки
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # CORS для загрузки файлов
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";

        proxy_pass http://content_loader/;
    }

    # Content Processor
    location /api/content/processor/ {
        # Приоритет обработки
        limit_req zone=api_processor burst=100 delay=10;

        # Быстрые таймауты
        proxy_connect_timeout 2s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;

        # Минимальная буферизация для скорости
        proxy_buffering on;
        proxy_buffer_size 1k;
        proxy_buffers 4 1k;
        proxy_busy_buffers_size 2k;

        # Заголовки
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-Start "${msec}";

        # Gzip сжатие для JSON ответов
        gzip on;
        gzip_types application/json;

        proxy_pass http://content_processor/;
    }

    # Price History
    location /api/price/ {
        # Rate limiting для ценовых данных
        limit_req zone=api_price burst=200 nodelay;

        # Таймауты
        proxy_connect_timeout 3s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;

        # Заголовки
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_pass http://price_history/;
    }

    # Notifications
    location /api/notifications/ {
        # Высокий burst для уведомлений
        limit_req zone=api_notifications burst=500 nodelay;

        # Длинные таймауты для почтовых операций
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Агрессивные ретраи для уведомлений
        proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
        proxy_next_upstream_timeout 5s;
        proxy_next_upstream_tries 5;

        # Буферизация для надежности
        proxy_buffering on;
        proxy_buffer_size 8k;
        proxy_buffers 16 8k;

        # Заголовки
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Priority "high";

        # Retry-After заголовок
        add_header Retry-After 30 always;

        proxy_pass http://notifications/;
    }

    # Default route
    location / {
        return 404;
    }
}